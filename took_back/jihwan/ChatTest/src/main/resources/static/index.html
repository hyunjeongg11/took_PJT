<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2/dist/stomp.min.js"></script>
</head>
<body>
<h1>Chat Application</h1>

<div>
    <h2>Create Chat Room</h2>
    <input type="text" id="roomTitle" placeholder="Room Title">
    <input type="text" id="userId" placeholder="User ID">
    <button onclick="createRoom()">Create Room</button>
</div>

<div>
    <h2>Chat Rooms</h2>
    <ul id="chatRooms"></ul>
</div>

<div id="chatSection" style="display:none;">
    <h2>Chat Room: <span id="currentRoom"></span></h2>
    <div id="messages"></div>
    <input type="text" id="messageInput" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
    <button onclick="leaveRoom()">Leave Room</button>
</div>

<script>
    let stompClient = null;
    let currentRoomSeq = null;
    let userId = null;

    function createRoom() {
        const roomTitle = document.getElementById("roomTitle").value;
        userId = document.getElementById("userId").value;

        fetch("/api/chat/room", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ roomTitle, userId })
        })
            .then(response => response.json())
            .then(room => {
                fetchRooms();
                alert(`Room created: ${room.roomTitle}`);
            });
    }

    function fetchRooms() {
        fetch("/api/chat/rooms")
            .then(response => response.json())
            .then(rooms => {
                const chatRooms = document.getElementById("chatRooms");
                chatRooms.innerHTML = "";
                rooms.forEach(room => {
                    const li = document.createElement("li");
                    li.textContent = room.roomTitle;
                    li.onclick = () => joinRoom(room.roomSeq, room.roomTitle);
                    chatRooms.appendChild(li);
                });
            });
    }

    function joinRoom(roomSeq, roomTitle) {
        currentRoomSeq = roomSeq;
        document.getElementById("currentRoom").textContent = roomTitle;
        document.getElementById("chatSection").style.display = "block";

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe(`/sub/chat/room/${roomSeq}`, function (message) {
                showMessage(JSON.parse(message.body));
            });
            stompClient.send(`/pub/room/${roomSeq}/enter`, {}, JSON.stringify({ userId }));
            fetchMessages(roomSeq);
        });
    }

    function fetchMessages(roomSeq) {
        fetch(`/api/chat/message/room/${roomSeq}`)
            .then(response => response.json())
            .then(messages => {
                const messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML = "";
                messages.forEach(message => showMessage(message));
            });
    }

    function sendMessage() {
        const message = document.getElementById("messageInput").value;
        stompClient.send("/pub/chat/message/send", {}, JSON.stringify({
            roomSeq: currentRoomSeq,
            userId,
            message
        }));
        document.getElementById("messageInput").value = "";
    }

    function leaveRoom() {
        stompClient.send(`/pub/room/${currentRoomSeq}/leave`, {}, JSON.stringify({ userId }));
        stompClient.disconnect(() => {
            document.getElementById("chatSection").style.display = "none";
            alert("You have left the room");
        });
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById("messages");
        const messageElement = document.createElement("div");
        messageElement.textContent = `${message.userId}: ${message.message}`;
        messagesDiv.appendChild(messageElement);
    }

    document.addEventListener("DOMContentLoaded", fetchRooms);
</script>
</body>
</html>
