<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Application</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        #chatRoom, #chatRooms, #chatInterface {
            display: none;
        }
    </style>
</head>
<body>
<h1>Chat Application</h1>

<div id="userIdInput">
    <h2>Enter User ID</h2>
    <input type="text" id="userId" placeholder="User ID">
    <button onclick="setUserId()">Enter</button>
</div>

<div id="chatRooms">
    <h2>Chat Rooms</h2>
    <button onclick="showCreateRoom()">Create Room</button>
    <div id="createRoom" style="display:none;">
        <input type="text" id="roomTitle" placeholder="Room Title">
        <input type="number" id="roomCategory" placeholder="Category">
        <button onclick="createRoom()">Create</button>
    </div>
    <div id="roomsList"></div>
</div>

<div id="chatRoom">
    <h2 id="roomTitleHeader"></h2>
    <div id="messages"></div>
    <input type="text" id="messageContent" placeholder="Message">
    <button onclick="sendMessage()">Send</button>
    <button onclick="leaveRoom()">Leave Room</button>
    <button onclick="backToRooms()">Back to Rooms</button>
</div>

<script>
    let stompClient = null;
    let currentUserId = null;
    let currentRoomSeq = null;

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/sub/chat/rooms', function (messageOutput) {
                console.log('Room list update received:', messageOutput.body);
                try {
                    showChatRooms(JSON.parse(messageOutput.body));
                } catch (error) {
                    console.error('Error parsing room list update:', error);
                }
            });
        });
    }

    function setUserId() {
        currentUserId = document.getElementById('userId').value;
        document.getElementById('userIdInput').style.display = 'none';
        document.getElementById('chatRooms').style.display = 'block';
        loadChatRooms();
    }

    function showCreateRoom() {
        document.getElementById('createRoom').style.display = 'block';
    }

    function createRoom() {
        const roomTitle = document.getElementById('roomTitle').value;
        const category = document.getElementById('roomCategory').value;
        const userId = currentUserId;
        fetch('/api/chat/room', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roomTitle: roomTitle, userId: userId, category: category })
        })
            .then(response => response.json())
            .then(data => {
                enterRoom(data.roomSeq, true);
            });
    }

    function loadChatRooms() {
        fetch('/api/chat/rooms')
            .then(response => response.json())
            .then(data => showChatRooms(data));
    }

    function showChatRooms(rooms) {
        const roomsList = document.getElementById('roomsList');
        roomsList.innerHTML = '';
        rooms.forEach(room => {
            const roomElement = document.createElement('div');
            roomElement.appendChild(document.createTextNode(room.roomTitle));
            roomElement.onclick = () => enterRoom(room.roomSeq, false);
            roomsList.appendChild(roomElement);
        });
    }

    function enterRoom(roomSeq, isCreator) {
        currentRoomSeq = roomSeq;
        document.getElementById('chatRooms').style.display = 'none';
        document.getElementById('chatRoom').style.display = 'block';
        document.getElementById('messages').innerHTML = '';  // Clear previous messages
        const enterRequest = { roomSeq: roomSeq, userId: currentUserId, type: 'ENTER' };
        console.log('Entering room with request:', enterRequest);
        if (!isCreator) {
            stompClient.send('/pub/room/enter', {}, JSON.stringify(enterRequest));
        }
        subscribeToRoomMessages(roomSeq);
        fetchRoomMessages(roomSeq);
    }

    function sendMessage() {
        const messageContent = document.getElementById('messageContent').value;
        const messageRequest = { type: 'TALK', roomSeq: currentRoomSeq, userId: currentUserId, message: messageContent };
        console.log('Sending message:', messageRequest);
        stompClient.send('/pub/send', {}, JSON.stringify(messageRequest));
        document.getElementById('messageContent').value = '';
    }

    function leaveRoom() {
        const leaveRequest = { roomSeq: currentRoomSeq, userId: currentUserId, type: 'EXIT' };
        console.log('Leaving room with request:', leaveRequest);
        stompClient.send('/pub/room/leave', {}, JSON.stringify(leaveRequest));
        backToRooms();
    }

    function backToRooms() {
        document.getElementById('chatRoom').style.display = 'none';
        document.getElementById('chatRooms').style.display = 'block';
        currentRoomSeq = null;
        loadChatRooms();
    }

    function subscribeToRoomMessages(roomSeq) {
        stompClient.subscribe('/sub/chat/room/' + roomSeq, function (messageOutput) {
            console.log('Message received:', messageOutput.body);
            try {
                showMessage(JSON.parse(messageOutput.body));
            } catch (error) {
                console.error('Error parsing message:', error);
            }
        });
    }

    function fetchRoomMessages(roomSeq) {
        fetch(`/api/chat/message/room/${roomSeq}`)
            .then(response => response.json())
            .then(data => {
                data.forEach(message => showMessage(message));
            });
    }

    function showMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        if (message.type === 'ENTER') {
            messageElement.appendChild(document.createTextNode(message.userId + '님이 입장하셨습니다.'));
        } else if (message.type === 'EXIT') {
            messageElement.appendChild(document.createTextNode(message.userId + '님이 퇴장하셨습니다.'));
        } else {
            messageElement.appendChild(document.createTextNode(message.userId + ': ' + message.message));
        }
        messagesDiv.appendChild(messageElement);
    }

    connect();
</script>
</body>
</html>