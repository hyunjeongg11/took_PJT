<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat Application</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        #chatRoom, #chatRooms {
            display: none;
        }
        .message-enter {
            color: green;
        }
        .message-exit {
            color: red;
        }
        .message-talk {
            color: black;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mt-5">Chat Application</h1>

    <div id="userIdInput" class="mt-3">
        <h2>Enter User ID</h2>
        <input type="text" id="userId" class="form-control" placeholder="User ID">
        <button onclick="setUserId()" class="btn btn-primary mt-2">Enter</button>
    </div>

    <div id="chatRooms" class="mt-3">
        <h2>Chat Rooms</h2>
        <button onclick="showCreateRoom()" class="btn btn-success">Create Room</button>
        <div id="createRoom" style="display:none;" class="mt-3">
            <input type="text" id="roomTitle" class="form-control" placeholder="Room Title">
            <input type="number" id="roomCategory" class="form-control mt-2" placeholder="Category">
            <button onclick="createRoom()" class="btn btn-primary mt-2">Create</button>
        </div>
        <div class="mt-3">
            <label for="categorySelect">Select Category:</label>
            <select id="categorySelect" class="form-control" onchange="filterRoomsByCategory()">
                <option value="">All Categories</option>
                <!-- Add specific categories here -->
                <option value="1">Category 1</option>
                <option value="2">Category 2</option>
                <option value="3">Category 3</option>
            </select>
        </div>
        <div id="roomsList" class="mt-3"></div>
    </div>

    <div id="chatRoom" class="mt-3">
        <h2 id="roomTitleHeader"></h2>
        <div id="messages" class="border p-3" style="height: 300px; overflow-y: scroll;"></div>
        <input type="text" id="messageContent" class="form-control mt-2" placeholder="Message">
        <button onclick="sendMessage()" class="btn btn-primary mt-2">Send</button>
        <button onclick="leaveRoom()" class="btn btn-danger mt-2">Leave Room</button>
        <button onclick="backToRooms()" class="btn btn-secondary mt-2">Back to Rooms</button>
        <button onclick="deleteRoom()" id="deleteRoomBtn" class="btn btn-danger mt-2" style="display:none;">Delete Room</button>
    </div>
</div>

<script>
    let stompClient = null;
    let currentUserId = null;
    let currentRoomSeq = null;
    let isCreator = false;
    let rooms = [];
    let currentSubscription = null;

    // WebSocket 연결 설정
    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/sub/chat/rooms', function (messageOutput) {
                loadChatRooms(); // 방 목록 불러오기
            });
        });
    }

    // 유저 ID 설정
    function setUserId() {
        currentUserId = document.getElementById('userId').value;
        document.getElementById('userIdInput').style.display = 'none';
        document.getElementById('chatRooms').style.display = 'block';
        loadChatRooms();
    }

    // 채팅방 생성 UI 표시
    function showCreateRoom() {
        document.getElementById('createRoom').style.display = 'block';
    }

    // 새로운 채팅방 생성
    function createRoom() {
        const roomTitle = document.getElementById('roomTitle').value;
        const category = document.getElementById('roomCategory').value;
        fetch('/api/chat/room', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roomTitle: roomTitle, category: category, userId: currentUserId })
        })
            .then(response => response.json())
            .then(data => {
                isCreator = true;
                enterRoom(data.roomSeq);
            });
    }

    // 모든 채팅방 로드
    function loadChatRooms() {
        fetch('/api/chat/rooms')
            .then(response => response.json())
            .then(data => {
                rooms = data;
                showChatRooms(rooms);
            });
    }

    // 카테고리별로 방 필터링
    function filterRoomsByCategory() {
        const selectedCategory = document.getElementById('categorySelect').value;
        const filteredRooms = selectedCategory ? rooms.filter(room => room.category == selectedCategory) : rooms;
        showChatRooms(filteredRooms);
    }

    // 채팅방 목록 표시
    function showChatRooms(rooms) {
        const roomsList = document.getElementById('roomsList');
        roomsList.innerHTML = '';
        rooms.forEach(room => {
            const roomElement = document.createElement('div');
            roomElement.className = 'border p-2 mt-2';
            roomElement.style.cursor = 'pointer';
            roomElement.onclick = () => enterRoom(room.roomSeq);
            roomElement.appendChild(document.createTextNode('방번호: ' + room.roomSeq + ' - ' + room.roomTitle + ' (Category: ' + room.category + ')'));
            roomsList.appendChild(roomElement);
        });
    }

    // 채팅방 입장
    function enterRoom(roomSeq) {
        if (currentSubscription) {
            currentSubscription.unsubscribe();
        }

        currentRoomSeq = roomSeq;
        document.getElementById('chatRooms').style.display = 'none';
        document.getElementById('chatRoom').style.display = 'block';
        document.getElementById('messages').innerHTML = '';  // 이전 메시지 초기화

        if (isCreator) {
            document.getElementById('deleteRoomBtn').style.display = 'block';
            isCreator = false;
        }

        const enterRequest = { roomSeq: roomSeq, userId: currentUserId };
        stompClient.send('/pub/room/enter', {}, JSON.stringify(enterRequest));

        currentSubscription = subscribeToRoomMessages(roomSeq);
        fetchRoomMessages(roomSeq);
    }

    // 메시지 전송
    function sendMessage() {
        const messageContent = document.getElementById('messageContent').value;
        const messageRequest = { type: 'TALK', roomSeq: currentRoomSeq, userId: currentUserId, message: messageContent };
        stompClient.send('/pub/message/send', {}, JSON.stringify(messageRequest));
        document.getElementById('messageContent').value = '';
    }

    // 채팅방 나가기
    function leaveRoom() {
        const leaveRequest = { roomSeq: currentRoomSeq, userId: currentUserId };
        stompClient.send('/pub/room/leave', {}, JSON.stringify(leaveRequest));
        backToRooms();
    }

    // 방 목록으로 돌아가기
    function backToRooms() {
        if (currentSubscription) {
            currentSubscription.unsubscribe();
        }
        document.getElementById('chatRoom').style.display = 'none';
        document.getElementById('chatRooms').style.display = 'block';
        currentRoomSeq = null;
        loadChatRooms();
    }

    // 채팅방 삭제
    function deleteRoom() {
        fetch(`/api/chat/room/${currentRoomSeq}`, {
            method: 'DELETE'
        }).then(() => {
            backToRooms();
        });
    }

    // 채팅방 메시지 구독
    function subscribeToRoomMessages(roomSeq) {
        return stompClient.subscribe('/sub/chat/room/' + roomSeq, function (messageOutput) {
            showMessage(JSON.parse(messageOutput.body));
        });
    }

    // 채팅방 메시지 가져오기
    function fetchRoomMessages(roomSeq) {
        fetch(`/api/chat/message/list`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roomSeq: roomSeq, userId: currentUserId, joinTime: new Date().toISOString() })
        })
            .then(response => response.json())
            .then(data => {
                data.forEach(message => showMessage(message));
            });
    }

    // 메시지 표시
    function showMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        let messageClass = '';
        switch(message.type) {
            case 'ENTER':
                messageClass = 'message-enter';
                break;
            case 'EXIT':
                messageClass = 'message-exit';
                break;
            case 'TALK':
                messageClass = 'message-talk';
                break;
        }
        messageElement.className = messageClass;
        messageElement.appendChild(document.createTextNode(message.userId + ': ' + message.message));
        messagesDiv.appendChild(messageElement);
    }

    connect();
</script>
</body>
</html>
